---
tags:
  - cs2107/chapter8
  - cs/security
  - cs/pwn
  - lang/c
complete: false
prev: /labyrinth/notes/cs/cs2107/control-flow_integrity
next: /labyrinth/notes/cs/cs2107/buffer_overflow

---
### Summary
Premise
- program prints user-supplied string directly as format argument
- eg. `printf(buf)` instead of `printf("%s", buf)`

Attack
- attacker crafts input containing [format specifiers](/labyrinth/notes/cs/cs2100/C#^0f41a6) (`%p`, %x`, `%s`, `%n`)
- `%x`/`%s` can leak stack memory
- `%n` writes number of bytes printed into an address - can be abused to overwrite memory
- `%i$x` can also be used, where `i` specifies the would be `i`th parameter
> usually `%p` is used preferably over `%x` since it assumes its printing a pointer, it formats the value with the `0x` prefix

Attackerâ€™s goals
- read sensitive memory -> confidentiality
- crash program -> execution integrity
- overwrite variables -> integrity

Defense
- avoid untrusted input as the format string, use `printf("hello world")`, `printf("%s", buf)`
- use safer IO wrappers or languages that handle formatting safely
- static code analysis and compiler warnings (enable `-Wformat`/`-Wformat-security`)
### Concept
Format string vulnerability
- exploits implemetation bug
- more paramters expected than provided

```c
int val = 1205;
printf("%x %x", val, val);
// out: 4b5 4b5
```
```tikz
\usepackage{tikz}
\usetikzlibrary{positioning,arrows.meta}
\def\frameh{8mm}
\begin{document}

\begin{tikzpicture}[
		thick,
    frame/.style={draw, minimum width=3cm, minimum height=\frameh, align=center, node distance=0}
]

% Stack frames (grows downward)
\foreach \i in {0,...,6} {
    \node[frame] (f\i) at (0,\frameh*\i) {};
}

\node at(f0) {...};
\node at(f1) {val = 1205};
\node[right=of f1] (p3) {parameter 3};
\draw[->] (p3) -- (f1);
\node at(f2) {val = 1205};
\node[right=of f2] (p2) {parameter 2};
\draw[->] (p2) -- (f2);
\node at(f3) {"\%x \%x"};
\node[right=of f3] (p1) {parameter 1};
\draw[->] (p1) -- (f3);
\node at(f4) {ra};
\node at(f5) {fp};
\node[right=of f5] (rbp) {$\$$rbp};
\draw[->] (rbp) -- (f5);
\node at(f6) {local variables};
\node[right=of f6] (rsp) {$\$$rsp};
\draw[->] (rsp) -- (f6);

\end{tikzpicture}
\end{document}
```

```c
int val = 1205;
printf("%x %x", val); // insufficient paramters
// out: 4b5 5659b000
```
```tikz
\usepackage{tikz}
\usetikzlibrary{positioning,arrows.meta}
\def\frameh{8mm}
\begin{document}

\begin{tikzpicture}[
		thick,
    frame/.style={draw, minimum width=3cm, minimum height=\frameh, align=center, node distance=0}
]

% Stack frames (grows downward)
\foreach \i in {0,...,5} {
    \node[frame] (f\i) at (0,\frameh*\i) {};
}

\node[red] at(f0) {...};
\node[right=of f0] (p3) {parameter 3};
\draw[->] (p3) -- (f0);
\node at(f1) {val = 1205};
\node[right=of f1] (p2) {parameter 2};
\draw[->] (p2) -- (f1);
\node at(f2) {"\%x \%x"};
\node[right=of f2] (p1) {parameter 1};
\draw[->] (p1) -- (f2);
\node at(f3) {ra};
\node at(f4) {fp};
\node[right=of f4] (rbp) {$\$$rbp};
\draw[->] (rbp) -- (f4);
\node at(f5) {local variables};
\node[right=of f5] (rsp) {$\$$rsp};
\draw[->] (rsp) -- (f5);

\end{tikzpicture}
\end{document}
```

Testing
- security testing to discover potential attacks
- white-box - tester has access to source code
- black-box - tester doesn't have access to source code
- grey-box - combination of both
- **fuzzing** -> test malformed inputs to discover vulnerability
- undocumented access points(easter eggs)
	- hidden backdoor for testing
	- may mistakenly remain in the final production program
	- becomes a backdoor for attackers
### Application
